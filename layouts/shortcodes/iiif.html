{{/*
Hugo Shortcode for IIIF Image API interation
Make sure to integrate the CSS styles of Leaflet and leaflet.fullscreen.

Parameters:
* src - The url to the 'info.json' file
* divId - The ID of the viewer <div> (optional - default 'iiif-image-' plus a random number)
* jsId - The variable name of the viewer <div> (optional - default 'map')
* includeSources - Include JavaScript sources (optional - default 'false')
*/}}

{{/*
{{ $leafletStyle := resources.Get "js/leaflet/leaflet.css" }}
{{ $leafletFullscreenStyle := resources.Get "js/leaflet.fullscreen/Control.FullScreen.css" }}
{{ $style := slice $leafletStyle $leafletFullscreenStyle | resources.Concat "css/leaflet.css" | minify }}
<link href="{{ $style.RelPermalink }}" rel="stylesheet">
*/}}

{{ if not (.Get "includeSources") }}
    {{ $leafletLib := resources.Get "js/leaflet/leaflet.js" }}
    {{ $leafletIiifLib := resources.Get "js/leaflet-iiif/leaflet-iiif.js" }}
    {{ $leafletFullscreenLib := resources.Get "js/leaflet.fullscreen/Control.FullScreen.js" }}
    {{ $js := slice $leafletLib $leafletIiifLib $leafletFullscreenLib | resources.Concat "js/leaflet.js" | minify | fingerprint }}
    <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}"></script>
{{ end }}

{{ $src := .Get "src" }}
{{ $id := printf "iiif-image-%s" (delimit (shuffle (seq 1 9)) "") }}
{{ if .Get "divId" }}
    {{ $id = .divId }}
{{ end }}
{{ $var := "map" }}
{{ if .Get "id" }}
    {{ $var = .jsId }}
{{ end }}

<a name="{{ $id }}"></a>
<div id="{{ $id }}" class="viewer"></div>

<script type="text/javascript">
  {{ $var | safeJS }} = L.map('{{ $id }}', {
          center: [0, 0],
          crs: L.CRS.Simple,
          zoom: 1,
          attributionControl:false,
          minZoom: 1,
          maxZoom: 6,
          fullscreenControl: true,
          fullscreenControlOptions: {
            title: '{{ i18n "startFullscreen" }}',
            titleCancel: '{{ i18n "exitFullscreen" }}'
          }
        });
  var {{ $var | safeJS -}}_layer = L.tileLayer.iiif("{{ $src }}", {tileSize: 512, fitBounds: true, setMaxBounds: true}).addTo({{ $var | safeJS }});
</script>
