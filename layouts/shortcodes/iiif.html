{{/*
Hugo Shortcode for IIIF Image API interation
Make sure to integrate the CSS styles of Leaflet and leaflet.fullscreen.

Parameters:
* src - The url to the 'info.json' file
* divId - The ID of the viewer <div> (optional - default 'iiif-image-' plus a random number)
* jsId - The variable name of the viewer <div> (optional - default 'map')
* includeSources - Include JavaScript sources (optional - default 'false')
*/}}

{{ if not (.Get "includeSources") }}
    {{/* JavaScript */}}
    {{ $leafletLib := resources.Get "js/leaflet/leaflet.js" }}
    {{ $leafletIiifLib := resources.Get "js/leaflet-iiif/leaflet-iiif.js" }}
    {{ $leafletFullscreenLib := resources.Get "js/leaflet.fullscreen/Control.FullScreen.js" }}
    {{ $js := slice $leafletLib $leafletIiifLib $leafletFullscreenLib | resources.Concat "js/leaflet.js" | minify | fingerprint }}
    <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}"></script>

    {{/* CSS - the stylesheet itself is generated in layout/_default/baseof.html */}}
    {{ $viewerOptions := (dict "targetPath" "viewer.css" "outputStyle" "compressed" "includePaths" (slice "node_modules/leaflet/dist/" "node_modules/leaflet.fullscreen/")) }}
    {{ $viewerTemplate := resources.Get "scss/viewer.scss" }}
    {{ $viewerStyle := $viewerTemplate | resources.ExecuteAsTemplate "scss/viewer.scss" . | toCSS $viewerOptions }}
    {{ $viewerCSS := slice $viewerStyle | resources.Concat "css/viewer.css" | minify | fingerprint }}
    <script type="text/javascript">
        var css = document.createElement("link");
        css.setAttribute("rel", "stylesheet");
        css.setAttribute("type", "text/css");
        css.setAttribute("href", '{{ $viewerCSS.RelPermalink }}');
        css.setAttribute("integrity", '{{ $viewerCSS.Data.Integrity }}');
        document.head.appendChild(css);
    </script>
{{ end }}

{{ $src := .Get "src" }}
{{ $id := printf "iiif-image-%s" (delimit (shuffle (seq 1 9)) "") }}
{{ if .Get "divId" }}
    {{ $id = .divId }}
{{ end }}
{{ $var := "map" }}
{{ if .Get "id" }}
    {{ $var = .jsId }}
{{ end }}

<a name="{{ $id }}"></a>
<div id="{{ $id }}" class="viewer"></div>

<script type="text/javascript">
    $(document).ready(function() {
      {{ $var | safeJS }} = L.map('{{ $id }}', {
              center: [0, 0],
              crs: L.CRS.Simple,
              zoom: 1,
              attributionControl:false,
              minZoom: 1,
              maxZoom: 6,
              fullscreenControl: true,
              fullscreenControlOptions: {
                title: '{{ i18n "startFullscreen" }}',
                titleCancel: '{{ i18n "exitFullscreen" }}'
              }
            });
      var {{ $var | safeJS -}}_layer = L.tileLayer.iiif("{{ $src }}", {tileSize: 512, fitBounds: true, setMaxBounds: true}).addTo({{ $var | safeJS }});
    });
</script>
